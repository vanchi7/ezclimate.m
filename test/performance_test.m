function performance_test
    addpath ..\data % poor man's import management
    addpath ..\src
    addpath ..\EZClimate-MATLAB
    addpath(genpath('..\dep\admat-2.0'))
    
    compare_performance
    scaling_performance  (3)
    extreme_performance  (3)
    num_grad_performance (3)
    profile_performance  (3)

    rmpath ..\data
    rmpath ..\src
    rmpath ..\EZClimate-MATLAB
    rmpath(genpath('..\dep\admat-2.0'))
end

function compare_performance
    param = utility_v_config;

    mits = [0.697761696466805, 0.853034558526121, 0.725151474155350, 1.041134384715706, 0.956013916061470, 0.972747784169145, 0.761556319227664, 1.193478341960530, 1.131100930854668, 1.160530030246598, 1.064935584242798, 1.188648314948183, 1.102787739350373, 1.040760013236461, 0.758161616384580, 1.072694494043509, 1.043657439917421, 1.103646953294773, 1.067166449562689, 1.108561146082528, 1.073625421456471, 1.166068576642049, 1.107020167988350, 1.108644295692657, 1.074028405660717, 1.159305474516272, 1.100862708921946, 1.299000054907720, 1.251047498283711, 1.473525471256901, 0.962615261280115, 0.947676821810615, 0.928486127243796, 0.951197457006953, 0.920784107560767, 0.959397761955144, 0.926581508095382, 0.965076145659975, 0.938788619680513, 0.960236170192503, 0.926960554438880, 0.963920900310840, 0.937013152861551, 0.972787909944345, 0.946783569868324, 1.003402653777684, 0.973317942522225, 0.959875359868599, 0.926380295381803, 0.961954655493991, 0.934345616424460, 0.970336458363138, 0.942778155192331, 0.998186030430271, 0.968435922663007, 0.988238673384833, 0.959790822109244, 1.008117497565536, 0.983244208646592, 1.092365176637111, 1.049014605393291, 1.029001758398304, 0.994438317203424];
    
    t_v  = repeat(@() utility_v  (mits, param), 100);
    t    = repeat(@() utilitycalc(mits), 10);
    fprintf('performance comparison\n')
    fprintf('%10s | %10s | %10s\n', 'time', 'orig.', 'vec.')
    fprintf('%10s | %10.4f | %10.4f\n', 'prim.', t, t_v)
    admat_startup
    optf = setgradopt('forwprod', numel(mits));
    optr = setgradopt('revprod', numel(mits));

    t_vf  = repeat(@() feval(ADfun(@utility_v, 1), mits, param, optf), 10);
    t_f   = repeat(@() feval(ADfun(@utilitycalc, 1), mits, [], optf), 2);

    fprintf('%10s | %10.4f | %10.4f\n', 'forw.', t_f  , t_vf)
    fprintf('%10s | %10.4f | %10.4f\n', 'ratio', t_f/t, t_vf/t_v)

    t_vr  = repeat(@() feval(ADfun(@utility_v, 1), mits, param, optr), 10);

    fprintf('%10s | %10.4f | %10.4f\n', 'rev.' , NaN, t_vr)
    fprintf('%10s | %10.4f | %10.4f\n', 'ratio', NaN, t_vr/t_v)
end

function scaling_performance (scale)
    mits = [0.697761696466805, 0.853034558526121, 0.725151474155350, 1.041134384715706, 0.956013916061470, 0.972747784169145, 0.761556319227664, 1.193478341960530, 1.131100930854668, 1.160530030246598, 1.064935584242798, 1.188648314948183, 1.102787739350373, 1.040760013236461, 0.758161616384580, 1.072694494043509, 1.043657439917421, 1.103646953294773, 1.067166449562689, 1.108561146082528, 1.073625421456471, 1.166068576642049, 1.107020167988350, 1.108644295692657, 1.074028405660717, 1.159305474516272, 1.100862708921946, 1.299000054907720, 1.251047498283711, 1.473525471256901, 0.962615261280115, 0.947676821810615, 0.928486127243796, 0.951197457006953, 0.920784107560767, 0.959397761955144, 0.926581508095382, 0.965076145659975, 0.938788619680513, 0.960236170192503, 0.926960554438880, 0.963920900310840, 0.937013152861551, 0.972787909944345, 0.946783569868324, 1.003402653777684, 0.973317942522225, 0.959875359868599, 0.926380295381803, 0.961954655493991, 0.934345616424460, 0.970336458363138, 0.942778155192331, 0.998186030430271, 0.968435922663007, 0.988238673384833, 0.959790822109244, 1.008117497565536, 0.983244208646592, 1.092365176637111, 1.049014605393291, 1.029001758398304, 0.994438317203424];

    admat_startup

    fprintf('scaling performance\n')
    fprintf('%10s | %10s | %10s | %10s | %10s\n', 'm length', 'utility', 'v', 'vf', 'vr');
    for ndecisions = 6:6+scale
        dtimes = [0:15:(ndecisions-2)*15, 285, 385];
        param = utility_v_config (true, dtimes, 5);
        optf = setgradopt('forwprod', numel(mits));
        optr = setgradopt('revprod', numel(mits));
        
        fprintf('%10d ', numel(mits));
        u = utility_v (mits, param);
        fprintf('| %10.4f ', u);
        
        t_v   = repeat(@() utility_v (mits, param), 10);
        fprintf('| %10.4f ', t_v);
        t_vf  = repeat(@() feval(ADfun(@utility_v, 1), mits, param, optf), 1);
        fprintf('| %10.4f ', t_vf);
        t_vr  = repeat(@() feval(ADfun(@utility_v, 1), mits, param, optr), 1);
        fprintf('| %10.4f\n', t_vr);
        
        mits(2^ndecisions:2^(ndecisions+1)-1) = repelem(mits(ceil(end/2):end), 1, 2);
    end
end

% Run with care. May crash machine with only 16 GB memory.
function extreme_performance (scale)
    mits = [0.697761696466805, 0.853034558526121, 0.725151474155350, 1.041134384715706, 0.956013916061470, 0.972747784169145, 0.761556319227664, 1.193478341960530, 1.131100930854668, 1.160530030246598, 1.064935584242798, 1.188648314948183, 1.102787739350373, 1.040760013236461, 0.758161616384580, 1.072694494043509, 1.043657439917421, 1.103646953294773, 1.067166449562689, 1.108561146082528, 1.073625421456471, 1.166068576642049, 1.107020167988350, 1.108644295692657, 1.074028405660717, 1.159305474516272, 1.100862708921946, 1.299000054907720, 1.251047498283711, 1.473525471256901, 0.962615261280115, 0.947676821810615, 0.928486127243796, 0.951197457006953, 0.920784107560767, 0.959397761955144, 0.926581508095382, 0.965076145659975, 0.938788619680513, 0.960236170192503, 0.926960554438880, 0.963920900310840, 0.937013152861551, 0.972787909944345, 0.946783569868324, 1.003402653777684, 0.973317942522225, 0.959875359868599, 0.926380295381803, 0.961954655493991, 0.934345616424460, 0.970336458363138, 0.942778155192331, 0.998186030430271, 0.968435922663007, 0.988238673384833, 0.959790822109244, 1.008117497565536, 0.983244208646592, 1.092365176637111, 1.049014605393291, 1.029001758398304, 0.994438317203424];

    admat_startup

    fprintf('extreme performance\n')
    fprintf('%10s | %10s | %10s | %10s\n', 'm length', 'v', 'vr', 'vr ratio');
    for ndecisions = 6:6+scale
        dtimes = [0:15:(ndecisions-2)*15, 285, 385];
        param = utility_v_config (true, dtimes, 5);
        optf = setgradopt('forwprod', numel(mits));
        optr = setgradopt('revprod', numel(mits));
        
        fprintf('%10d ', numel(mits));
        
        t_v   = repeat(@() utility_v (mits, param), 10);
        fprintf('| %10.4f ', t_v);
        t_vr  = repeat(@() feval(ADfun(@utility_v, 1), mits, param, optr), 1);
        fprintf('| %10.4f ', t_vr);
        fprintf('| %10.4f\n', t_vr/t_v);
        
        mits(2^ndecisions:2^(ndecisions+1)-1) = repelem(mits(ceil(end/2):end), 1, 2);
    end
end

function profile_performance (scale)
    mits = [0.697761696466805, 0.853034558526121, 0.725151474155350, 1.041134384715706, 0.956013916061470, 0.972747784169145, 0.761556319227664, 1.193478341960530, 1.131100930854668, 1.160530030246598, 1.064935584242798, 1.188648314948183, 1.102787739350373, 1.040760013236461, 0.758161616384580, 1.072694494043509, 1.043657439917421, 1.103646953294773, 1.067166449562689, 1.108561146082528, 1.073625421456471, 1.166068576642049, 1.107020167988350, 1.108644295692657, 1.074028405660717, 1.159305474516272, 1.100862708921946, 1.299000054907720, 1.251047498283711, 1.473525471256901, 0.962615261280115, 0.947676821810615, 0.928486127243796, 0.951197457006953, 0.920784107560767, 0.959397761955144, 0.926581508095382, 0.965076145659975, 0.938788619680513, 0.960236170192503, 0.926960554438880, 0.963920900310840, 0.937013152861551, 0.972787909944345, 0.946783569868324, 1.003402653777684, 0.973317942522225, 0.959875359868599, 0.926380295381803, 0.961954655493991, 0.934345616424460, 0.970336458363138, 0.942778155192331, 0.998186030430271, 0.968435922663007, 0.988238673384833, 0.959790822109244, 1.008117497565536, 0.983244208646592, 1.092365176637111, 1.049014605393291, 1.029001758398304, 0.994438317203424];

    admat_startup

    ndecisions = 6+scale;

    for n = 6:ndecisions-1
        mits(2^n:2^(n+1)-1) = repelem(mits(ceil(end/2):end), 1, 2);
    end

    dtimes = [0:15:(ndecisions-2)*15, 285, 385];
    param = utility_v_config (true, dtimes, 5);
    optf = setgradopt('forwprod', numel(mits));
    optr = setgradopt('revprod', numel(mits));

    fprintf('profiling\n')
    profile on
    feval(ADfun(@utility_v, 1), mits, param, optr);
    profile off
    profreport
end

function num_grad_performance (scale)
    mits = [0.697761696466805, 0.853034558526121, 0.725151474155350, 1.041134384715706, 0.956013916061470, 0.972747784169145, 0.761556319227664, 1.193478341960530, 1.131100930854668, 1.160530030246598, 1.064935584242798, 1.188648314948183, 1.102787739350373, 1.040760013236461, 0.758161616384580, 1.072694494043509, 1.043657439917421, 1.103646953294773, 1.067166449562689, 1.108561146082528, 1.073625421456471, 1.166068576642049, 1.107020167988350, 1.108644295692657, 1.074028405660717, 1.159305474516272, 1.100862708921946, 1.299000054907720, 1.251047498283711, 1.473525471256901, 0.962615261280115, 0.947676821810615, 0.928486127243796, 0.951197457006953, 0.920784107560767, 0.959397761955144, 0.926581508095382, 0.965076145659975, 0.938788619680513, 0.960236170192503, 0.926960554438880, 0.963920900310840, 0.937013152861551, 0.972787909944345, 0.946783569868324, 1.003402653777684, 0.973317942522225, 0.959875359868599, 0.926380295381803, 0.961954655493991, 0.934345616424460, 0.970336458363138, 0.942778155192331, 0.998186030430271, 0.968435922663007, 0.988238673384833, 0.959790822109244, 1.008117497565536, 0.983244208646592, 1.092365176637111, 1.049014605393291, 1.029001758398304, 0.994438317203424];

    fprintf('num_grad performance\n')
    fprintf('%10s | %10s | %10s | %10s\n', 'm length', 'v', 'vn', 'vn ratio');
    for ndecisions = 6:6+scale
        dtimes = [0:15:(ndecisions-2)*15, 285, 385];
        param = utility_v_config (true, dtimes, 5);
        
        fprintf('%10d ', numel(mits));
        
        t_v   = repeat(@() utility_v (mits, param), 10);
        fprintf('| %10.4f ', t_v);
        t_vn  = repeat(@() num_grad(@(m) utility_v(m, param), mits, 1e-8), 1);
        fprintf('| %10.4f ', t_vn);
        fprintf('| %10.4f\n', t_vn/t_v);
        
        mits(2^ndecisions:2^(ndecisions+1)-1) = repelem(mits(ceil(end/2):end), 1, 2);
    end
end

function t = repeat(f, n)
    tic
    for k = 1:n
        f();
    end
    t = toc ./ n;
end

function g = num_grad(f, x, h)
    g = zeros(size(x));
    v = f(x);
    for k = 1:numel(x)
        x_h = x;
        x_h(k) = x(k) + h;
        g(k) = (f(x_h) - v) ./ h;
    end
end
